<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitNex Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #8b5cf6;
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --danger: #ef4444;
            --danger-light: #f87171;
            --info: #06b6d4;
            --info-light: #22d3ee;
            
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --white: #ffffff;
            
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-danger: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-warning: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            
            --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            --blur-backdrop: blur(16px);
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: var(--gray-900);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--blur-backdrop);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo i {
            background: var(--gradient-primary);
            -webkit-text-fill-color: transparent;
            font-size: 1.75rem;
        }

        .nav-menu {
            padding: 1.5rem 0;
        }

        .nav-item {
            margin: 0 1rem 0.75rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .nav-link:hover::before {
            width: 100%;
        }

        .nav-link:hover {
            color: var(--white);
            transform: translateX(4px);
        }

        .nav-link.active {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-lg);
        }

        .nav-link.active::before {
            width: 100%;
        }

        .nav-link i {
            font-size: 1.125rem;
            width: 20px;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.1);
        }

        .topbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--blur-backdrop);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
            box-shadow: var(--shadow-sm);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
            font-family: inherit;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--gray-700);
            backdrop-filter: var(--blur-backdrop);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: var(--white);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
            color: var(--white);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: var(--white);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, var(--info-light) 100%);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            border-radius: 8px;
        }

        .content-area {
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--blur-backdrop);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            background: var(--gradient-primary);
            color: var(--white);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-900);
            font-family: 'JetBrains Mono', monospace;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Form Layout Improvements */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(99, 102, 241, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .form-section-title {
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-actions .btn {
            min-width: 150px;
        }

        /* Create User Specific Styles */
        .create-user-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 500px;
        }

        .create-user-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .create-user-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .create-user-header h2 i {
            margin-right: 0.5rem;
            color: var(--primary);
        }

        .create-user-header p {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .create-user-form-wrapper {
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            backdrop-filter: var(--blur-backdrop);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Ensure tab content is visible */
        #create-user-tab {
            min-height: 600px;
            display: none;
        }

        #create-user-tab.active {
            display: block !important;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--blur-backdrop);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .panel-header {
            padding: 2rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.5);
        }

        .tab {
            flex: 1;
            padding: 1.25rem 1.5rem;
            background: none;
            border: none;
            color: var(--gray-600);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .tab.active::before {
            width: 100%;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .tab:hover::before {
            width: 100%;
        }

        .tab:hover {
            color: var(--gray-900);
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1.25rem 1rem 3rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--blur-backdrop);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: var(--white);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 1rem;
        }

        .table-container {
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            max-height: 70vh;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: var(--blur-backdrop);
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            color: var(--gray-700);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            backdrop-filter: var(--blur-backdrop);
        }

        .table td {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
        }

        .table tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .table tr:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: scale(1.01);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 3rem;
            height: 3rem;
            background: var(--gradient-primary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .avatar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: conic-gradient(from 180deg, #667eea, #764ba2, #667eea);
            border-radius: 50%;
            z-index: -1;
            animation: rotate 3s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .user-details h4 {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .user-details p {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(52, 211, 153, 0.2) 100%);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(251, 191, 36, 0.2) 100%);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(248, 113, 113, 0.2) 100%);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-info {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(34, 211, 238, 0.2) 100%);
            color: var(--info);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--blur-backdrop);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            background: var(--white);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: var(--blur-backdrop);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--blur-backdrop);
            border-radius: var(--border-radius-xl);
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-close:hover {
            color: var(--gray-600);
            transform: scale(1.1);
        }

        .modal-title {
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--blur-backdrop);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            box-shadow: var(--shadow-xl);
            z-index: 1100;
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.info {
            border-left: 4px solid var(--info);
        }

        .loading {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .device-limit-warning {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(248, 113, 113, 0.1) 100%);
            border-left: 4px solid var(--danger);
        }

        .device-count-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .device-count-normal {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(52, 211, 153, 0.2) 100%);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .device-count-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(251, 191, 36, 0.2) 100%);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .device-count-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(248, 113, 113, 0.2) 100%);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .password-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
            font-family: 'JetBrains Mono', monospace;
        }

        .password-text {
            flex: 1;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        /* Professional Contact Info Styling */
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .contact-item i {
            width: 16px;
            color: var(--gray-400);
        }

        .phone-number {
            color: var(--gray-700);
            font-weight: 500;
        }

        .sip-username {
            color: var(--gray-500);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Enhanced SMS Counter Display */
        .sms-counter {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .sms-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            font-family: 'JetBrains Mono', monospace;
        }

        .sms-breakdown {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-align: center;
        }

        /* PJSIP Device Status Styling */
        .device-status {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .device-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-available {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(52, 211, 153, 0.2) 100%);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-unavailable {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(248, 113, 113, 0.2) 100%);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-nonqual {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(251, 191, 36, 0.2) 100%);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .device-details {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--gray-600);
            background: rgba(0, 0, 0, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-top: 0.25rem;
        }

        .rtt-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .rtt-good {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .rtt-fair {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .rtt-poor {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
            
            .menu-toggle {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 110;
                background: var(--gradient-primary);
                color: var(--white);
                border: none;
                width: 3rem;
                height: 3rem;
                border-radius: 50%;
                cursor: pointer;
                box-shadow: var(--shadow-lg);
            }
        }

        .menu-toggle {
            display: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .topbar {
                padding: 1rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .actions {
                flex-direction: column;
                gap: 0.25rem;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Glassmorphism Effects */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: var(--blur-backdrop);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Enhanced Button Animations */
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }

        /* Status Indicators */
        .status-online {
            position: relative;
        }

        .status-online::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            border: 2px solid var(--white);
        }

        /* Hover Effects for Cards */
        .interactive-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .interactive-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
    </style>
    <script>
        if (sessionStorage.getItem('loggedIn') !== 'true') {
            window.location.href = "/login.html";
        }
    </script>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-rocket"></i>
                BitNex Admin
            </div>
        </div>
        <nav class="nav-menu">
            <div class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showUsersSection()">
                    <i class="fas fa-users"></i>
                    Users
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showDevicesSection()">
                    <i class="fas fa-mobile-alt"></i>
                    Online Devices
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showSessionsSection()">
                    <i class="fas fa-wifi"></i>
                    Sessions
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showCreateUserSection()">
                    <i class="fas fa-user-plus"></i>
                    Create User
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="topbar">
            <h1 class="page-title">Dashboard</h1>
            <div class="topbar-actions">
                <button class="btn btn-info" onclick="showDeviceBans()">
                    <i class="fas fa-mobile-alt"></i>
                    Device Bans
                </button>
                <button class="btn btn-warning" onclick="showTempBans()">
                    <i class="fas fa-clock"></i>
                    Temp Bans
                </button>
                <button class="btn btn-danger" onclick="showBannedUsers()">
                    <i class="fas fa-ban"></i>
                    Banned Users
                </button>
                <button class="btn btn-primary" onclick="showCreateUserModal()">
                    <i class="fas fa-plus"></i>
                    Add User
                </button>
                <button class="btn btn-secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card interactive-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Users</div>
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalUsers">0</div>
                </div>
                <div class="stat-card interactive-card">
                    <div class="stat-header">
                        <div class="stat-title">Active Users</div>
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="activeUsers">0</div>
                </div>
                <div class="stat-card interactive-card">
                    <div class="stat-header">
                        <div class="stat-title">Online Devices</div>
                        <div class="stat-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="onlineDevices">0</div>
                </div>
                <div class="stat-card interactive-card">
                    <div class="stat-header">
                        <div class="stat-title">Active Sessions</div>
                        <div class="stat-icon">
                            <i class="fas fa-wifi"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="onlineSessions">0</div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Main Panel -->
                <div class="main-panel">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('users')">
                            <i class="fas fa-users"></i>
                            Users Management
                        </button>
                        <button class="tab" onclick="switchTab('devices')">
                            <i class="fas fa-mobile-alt"></i>
                            Online Devices
                        </button>
                        <button class="tab" onclick="switchTab('sessions')">
                            <i class="fas fa-wifi"></i>
                            Active Sessions
                        </button>
                        <button class="tab" onclick="switchTab('create-user')">
                            <i class="fas fa-user-plus"></i>
                            Create New User
                        </button>
                    </div>

                    <!-- Users Tab -->
                    <div id="users-tab" class="tab-content active">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search users by name, email, or phone..." onkeyup="filterTable('usersTable', this.value)">
                        </div>
                        <div class="table-container">
                            <div class="table-wrapper">
                                <table class="table" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>User Profile</th>
                                            <th>Contact Information</th>
                                            <th>Domain</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Credentials</th>
                                            <th>SMS Usage</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Online Devices Tab -->
                    <div id="devices-tab" class="tab-content">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search devices by AOR, IP, or User-Agent..." onkeyup="filterTable('devicesTable', this.value)">
                        </div>
                        <div class="table-container">
                            <div class="table-wrapper">
                                <table class="table" id="devicesTable">
                                    <thead>
                                        <tr>
                                            <th>AOR / Extension</th>
                                            <th>Contact Status</th>
                                            <th>Connection Details</th>
                                            <th>User Agent</th>
                                            <th>Response Time</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Sessions Tab -->
                    <div id="sessions-tab" class="tab-content">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search sessions by user, extension, or session ID..." onkeyup="filterTable('sessionsTable', this.value)">
                        </div>
                        <div class="table-container">
                            <table class="table" id="sessionsTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Extension</th>
                                        <th>Session ID</th>
                                        <th>Status</th>
                                        <th>Login Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Create User Tab -->
                    <div id="create-user-tab" class="tab-content">
                        <div style="max-width: 800px; margin: 0 auto;">
                            <div class="panel-header" style="margin-bottom: 2rem; padding: 0; background: none; border: none;">
                                <div class="panel-title" style="font-size: 1.5rem;">
                                    <i class="fas fa-user-plus"></i>
                                    Create New User Account
                                </div>
                                <p style="margin-top: 0.5rem; color: var(--gray-600); font-size: 0.875rem;">
                                    Fill in the details below to create a new user account with access to the system.
                                </p>
                            </div>
                            
                            <form id="createUserForm">
                                <!-- Basic Information Section -->
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-user"></i>
                                        Basic Information
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-envelope"></i>
                                                Email Address
                                            </label>
                                            <input type="email" class="form-input" id="email" name="email" placeholder="user@company.com" required oninput="this.value = this.value.replace(/\s/g, '')">                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-key"></i>
                                                Password
                                            </label>
                                            <input type="text" class="form-input" id="password" name="password" placeholder="Enter secure password" required>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-user"></i>
                                                Full Name
                                            </label>
                                            <input type="text" class="form-input" id="fullName" name="fullName" placeholder="John Doe" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-phone"></i>
                                                Phone Number
                                            </label>
                                            <input type="text" class="form-input" id="senderPhone" name="senderPhone" placeholder="+1 (555) 123-4567" oninput="this.value = this.value.replace(/\s/g, '')">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-building"></i>
                                                Company Name
                                            </label>
                                            <input type="text" class="form-input" id="companyName" name="companyName" placeholder="Company Inc." required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-user-tag"></i>
                                                Role
                                            </label>
                                            <select class="form-select" id="role" name="role">
                                                <option value="user">User</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- SIP Configuration Section -->
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-phone-alt"></i>
                                        SIP Configuration (Optional)
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">SIP Username</label>
                                            <input type="text" class="form-input" id="sipUsername" name="sipUsername" placeholder="sip_user" oninput="this.value = this.value.replace(/\s/g, '')">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">SIP Password</label>
                                            <input type="text" class="form-input" id="sipPassword" name="sipPassword" placeholder="sip_password">
                                        </div>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="resetCreateUserForm()">
                                        <i class="fas fa-undo"></i>
                                        Reset Form
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus"></i>
                                        Create User Account
                                    </button>
                                </div>

                                <!-- Hidden Fields -->
                                <input type="hidden" id="domain" name="domain" value="bkpmanual.bitnexdial.com">
                                <input type="hidden" id="secureWebSocketServer" name="secureWebSocketServer" value="bkpmanual.bitnexdial.com">
                                <input type="hidden" id="webSocketPort" name="webSocketPort" value="8089">
                                <input type="hidden" id="webSocketPath" name="webSocketPath" value="/ws">
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePasswordModal()">&times;</button>
            <h3 class="modal-title">
                <i class="fas fa-key"></i>
                Update Password
            </h3>
            <form id="updatePasswordForm">
                <input type="hidden" id="updateUserId">
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="newPassword" placeholder="Enter new secure password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    Update Password
                </button>
            </form>
        </div>
    </div>

    <div id="emailModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            <h3 class="modal-title">
                <i class="fas fa-envelope"></i>
                Update Email Address
            </h3>
            <form id="updateEmailForm">
                <input type="hidden" id="updateEmailUserId">
                <div class="form-group">
                    <label class="form-label">New Email Address</label>
                    <input type="email" class="form-input" id="newEmail" placeholder="Enter new email address" required oninput="this.value = this.value.replace(/\s/g, '')">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    Update Email
                </button>
            </form>
        </div>
    </div>

    <script>
        let currentUpdatingUserId = null;
        let usersData = [];
        let sessionsData = [];
        let onlineDevicesData = [];

        // Mobile menu toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Enhanced notification system with better styling
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-${icons[type]} ${type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : type === 'warning' ? 'text-yellow-500' : 'text-blue-500'}" style="font-size: 1.25rem;"></i>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">
                            ${type.charAt(0).toUpperCase() + type.slice(1)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // Navigation functions
        function showUsersSection() {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            switchTab('users');
        }

        function showDevicesSection() {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            switchTab('devices');
        }

        function showSessionsSection() {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            switchTab('sessions');
        }

        function showCreateUserSection() {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            switchTab('create-user');
        }

        // Tab switching with create user support and debugging
        function switchTab(tabName) {            
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Add active class to the correct tab button
            const tabs = document.querySelectorAll('.tab');
            if (tabName === 'users') {
                tabs[0].classList.add('active');
            } else if (tabName === 'devices') {
                tabs[1].classList.add('active');
            } else if (tabName === 'sessions') {
                tabs[2].classList.add('active');
            } else if (tabName === 'create-user') {
                tabs[3].classList.add('active');
            }
            
            // Show the correct tab content
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block';
                
                // Load data for specific tabs
                if (tabName === 'devices' && onlineDevicesData.length === 0) {
                    fetchOnlineDevices();
                } else if (tabName === 'sessions' && sessionsData.length === 0) {
                    fetchSessions();
                } else if (tabName === 'create-user') {
                    // Focus on first input after a small delay
                    setTimeout(() => {
                        const emailInput = document.getElementById('email');
                        if (emailInput) {
                            emailInput.focus();
                        }
                    }, 100);
                }
            } else {
                console.error('Tab content not found:', tabName + '-tab');
            }
        }

        // Reset create user form function
        function resetCreateUserForm() {
            if (confirm('Are you sure you want to reset the form? All entered data will be lost.')) {
                document.getElementById('createUserForm').reset();
                showNotification('Form has been reset', 'info');
            }
        }

        // PJSIP Online Devices Functions
        async function fetchOnlineDevices() {
            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/pjsip-online-details");
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }    
                onlineDevicesData = await response.json();
                
                displayOnlineDevices(onlineDevicesData);
                updateStats();
            } catch (error) {
                showNotification("Failed to fetch online devices data", "error");
                
                // Display error state
                const tbody = document.getElementById("devicesTable").querySelector("tbody");
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--danger);"></i>
                            <strong>Failed to load online devices</strong><br>
                            <small>Please check the console for detailed error information</small><br>
                            <button class="btn btn-primary" onclick="fetchOnlineDevices()" style="margin-top: 1rem;">
                                <i class="fas fa-sync-alt"></i> Retry
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function displayOnlineDevices(devices) {
            const tbody = document.getElementById("devicesTable").querySelector("tbody");
            
            if (!tbody) {
                console.error(' Devices table body not found!');
                return;
            }
            
            tbody.innerHTML = "";

            if (!devices || devices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-mobile-alt" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                            No online devices found
                        </td>
                    </tr>
                `;
                return;
            }

            devices.forEach((device, index) => {
                
                const row = tbody.insertRow();
                const aorInitials = device.aor ? device.aor.substring(0, 2).toUpperCase() : 'UN';
                
                // Determine status class and text
                let statusClass = 'status-unavailable';
                let statusText = 'Unavailable';
                
                if (device.contact_status) {
                    if (device.contact_status.toLowerCase().includes('avail')) {
                        statusClass = 'status-available';
                        statusText = 'Available';
                    } else if (device.contact_status.toLowerCase().includes('nonqual')) {
                        statusClass = 'status-nonqual';
                        statusText = 'No Qualify';
                    }
                }
                
                // Determine RTT quality
                let rttClass = 'rtt-good';
                let rttQuality = 'Good';
                
                if (device.qualify_rtt) {
                    if (device.qualify_rtt > 200) {
                        rttClass = 'rtt-poor';
                        rttQuality = 'Poor';
                    } else if (device.qualify_rtt > 100) {
                        rttClass = 'rtt-fair';
                        rttQuality = 'Fair';
                    }
                }
                
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="avatar ${statusClass === 'status-available' ? 'status-online' : ''}">${aorInitials}</div>
                            <div class="user-details">
                                <h4>${device.aor || 'Unknown AOR'}</h4>
                                <p style="font-size: 0.75rem;">${device.contact || 'No contact info'}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="device-status">
                            <div class="device-status-badge ${statusClass}">
                                <i class="fas fa-${statusClass === 'status-available' ? 'check-circle' : statusClass === 'status-nonqual' ? 'exclamation-triangle' : 'times-circle'}"></i>
                                ${statusText}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="device-details">
                            <div style="margin-bottom: 0.25rem;">
                                <i class="fas fa-network-wired"></i>
                                <strong>IP:</strong> ${device.ip || 'Unknown'}:${device.port || 'N/A'}
                            </div>
                            <div style="margin-bottom: 0.25rem;">
                                <i class="fas fa-exchange-alt"></i>
                                <strong>Transport:</strong> ${device.transport || 'Unknown'}
                            </div>
                            ${device.expires ? `
                                <div>
                                    <i class="fas fa-clock"></i>
                                    <strong>Expires:</strong> ${device.expires}s
                                </div>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="max-width: 200px; word-break: break-all; font-size: 0.75rem; color: var(--gray-600);">
                            ${device.user_agent || 'Unknown User-Agent'}
                        </div>
                    </td>
                    <td>
                        ${device.qualify_rtt ? `
                            <div class="rtt-badge ${rttClass}">
                                <i class="fas fa-tachometer-alt"></i>
                                ${device.qualify_rtt}ms (${rttQuality})
                            </div>
                        ` : `
                            <div class="rtt-badge" style="background: rgba(156, 163, 175, 0.2); color: var(--gray-500);">
                                <i class="fas fa-question-circle"></i>
                                No RTT data
                            </div>
                        `}
                    </td>
                    <td>
                        <div class="actions" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button 
                                class="btn btn-sm btn-info" 
                                onclick="showUserDevices('${device.aor}', 'User ${device.aor}')"
                                title="Manage all devices for this user"
                            >
                                <i class="fas fa-users-cog"></i>
                                Manage User (${device.aor})
                            </button>
                            <div style="display: flex; gap: 0.25rem;">
                                <button 
                                    class="btn btn-sm btn-warning" 
                                    onclick="kickSpecificDevice('${device.contact}', '${device.aor}', 'User ${device.aor}')"
                                    title="Ban this specific device temporarily"
                                    ${!device.contact ? 'disabled' : ''}
                                >
                                    <i class="fas fa-mobile-alt"></i>
                                    Ban Device
                                </button>
                                <button 
                                    class="btn btn-sm btn-secondary" 
                                    onclick="quickKickDevice('${device.contact}', '${device.aor}')"
                                    title="Quick kick (no ban)"
                                    ${!device.contact ? 'disabled' : ''}
                                >
                                    <i class="fas fa-sign-out-alt"></i>
                                    Kick
                                </button>
                            </div>
                        </div>
                    </td>
                `;
            });

            document.getElementById('onlineDevices').textContent = devices.length;
        }

        // Kick device function
        async function kickDevice(contact, aor) {
            if (!contact) {
                showNotification("Cannot kick device: No contact information available", "warning");
                return;
            }

            if (!confirm(` Kick Device Confirmation\n\nThis will immediately disconnect the device: ${aor}\nContact: ${contact}\n\nAre you sure you want to continue?`)) {
                return;
            }

            try {                
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/pjsip-kick-device", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contact: contact })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`Device ${aor} has been kicked successfully`, "success");
                    // Refresh the devices list after a short delay
                    setTimeout(() => {
                        fetchOnlineDevices();
                    }, 2000);
                } else {
                    showNotification(`Failed to kick device: ${result.error}`, "error");
                }
            } catch (error) {
                console.error("Error kicking device:", error);
                showNotification("Failed to kick device", "error");
            }
        }

        // Show device details function
        function showDeviceDetails(aor, deviceDataJson) {
            try {
                const device = JSON.parse(deviceDataJson.replace(/&quot;/g, '"'));
                
                let detailsHtml = `
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: var(--gray-100); padding: 1rem; border-radius: var(--border-radius); max-height: 300px; overflow-y: auto;">
                        <h4 style="margin-bottom: 1rem; font-family: 'Inter', sans-serif;">Device Details: ${aor}</h4>
                `;
                
                Object.entries(device).forEach(([key, value]) => {
                    if (value !== null && value !== undefined && value !== '') {
                        detailsHtml += `<div><strong>${key}:</strong> ${value}</div>`;
                    }
                });
                
                detailsHtml += `</div>`;
                
                // Create a simple modal for device details
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        <h3 class="modal-title">
                            <i class="fas fa-mobile-alt"></i>
                            Device Information
                        </h3>
                        ${detailsHtml}
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error("Error parsing device data:", error);
                showNotification("Failed to display device details", "error");
            }
        }

        // Enhanced fetch users with professional display
// 1. First, let's add better error handling to the frontend fetchUsers function
// Replace the fetchUsers function in admin.html with this:

async function fetchUsers() {
    try {
        console.log(' Fetching users from API...');
        const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/users");
        
        console.log(' Response status:', response.status);
        console.log(' Response headers:', response.headers);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(' API Error Response:', errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
        }
        
        const responseText = await response.text();
        console.log(' Raw response:', responseText);
        
        let usersData;
        try {
            usersData = JSON.parse(responseText);
        } catch (parseError) {
            console.error(' JSON Parse Error:', parseError);
            console.error(' Response was:', responseText);
            throw new Error('Invalid JSON response from server');
        }
        
        console.log(' Parsed users data:', usersData);
        
        // Check if it's an array
        if (!Array.isArray(usersData)) {
            console.error(' Expected array but got:', typeof usersData, usersData);
            throw new Error('API returned non-array data');
        }
        
        // Store globally and display
        window.usersData = usersData;
        displayUsers(usersData);
        updateStats();
        
    } catch (error) {
        console.error(" Error fetching users:", error);
        showNotification("Failed to fetch users data: " + error.message, "error");
        
        // Display error in table
        const tbody = document.getElementById("usersTable")?.querySelector("tbody");
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--danger);"></i>
                        <strong>Failed to load users</strong><br>
                        <small>${error.message}</small><br>
                        <button class="btn btn-primary" onclick="fetchUsers()" style="margin-top: 1rem;">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                    </td>
                </tr>
            `;
        }
    }
}

console.log(' Debugging endpoints and improved error handling added');

        // Enhanced user display with professional styling
// Replace the actions column in your existing displayUsers function with this updated version:

function displayUsers(users) {
    const tbody = document.getElementById("usersTable").querySelector("tbody");
    tbody.innerHTML = "";

    users.forEach(user => {
        const row = tbody.insertRow();
        const initials = user.fullName ? user.fullName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
        const isBanned = user.status === 'banned';
        
        if (isBanned) {
            row.classList.add('device-limit-warning');
        }
        
        row.innerHTML = `
            <td>
                <div class="user-info">
                    <div class="avatar ${user.status !== 'banned' ? 'status-online' : ''}">${initials}</div>
                    <div class="user-details">
                        <h4>${user.email || 'Unknown User'}</h4>
                        <p>${user.fullName}</p>
                    </div>
                </div>
            </td>
            <td>
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span class="phone-number">${user.senderPhone || 'No phone set'}</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-phone-alt"></i>
                        <span class="sip-username">${user.sipUsername || 'No SIP configured'}</span>
                    </div>
                </div>
            </td>
            <td>
                <select class="form-input" style="padding: 0.5rem;" onchange="changeUserDomain('${user.id}', this.value)">
                    <option value="bkpmanual.bitnexdial.com" ${user.domain === "bkpmanual.bitnexdial.com" ? "selected" : ""}>bkpmanual.bitnexdial.com</option>
                </select>
            </td>
            <td>
                <span class="badge ${user.role === 'admin' ? 'badge-warning' : 'badge-info'}">${user.role}</span>
            </td>
            <td>
                <span class="badge ${user.status === "banned" ? 'badge-danger' : 'badge-success'}">${user.status === "banned" ? 'Banned' : 'Active'}</span>
                ${isBanned ? `
                    <button class="btn btn-sm btn-success" onclick="unbanUser('${user.id}', '${user.fullName}', '${user.sipUsername}')" title="Unban User" style="margin-left: 0.5rem;">
                        <i class="fas fa-unlock"></i> Unban
                    </button>
                ` : ''}
            </td>
            <td>
                <div class="password-display">
                    <span class="password-text" id="pwd-${user.id}"></span>
                    <button class="btn btn-sm btn-secondary" onclick="togglePassword('${user.id}', '${user.plainPassword || ''}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="copyPassword('${user.plainPassword || ''}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </td>
            <td id="sms-${user.id}">
                <div class="sms-counter">
                    <div class="loading"></div>
                </div>
            </td>
            <td>
                <div class="actions">
                    <button class="btn btn-sm ${user.status === 'banned' ? 'btn-success' : 'btn-danger'}"
                        onclick="toggleBan('${user.id}', this)"
                        title="${user.status === 'banned' ? 'Unban' : 'Ban'} User">
                        <i class="fas fa-${user.status === 'banned' ? 'unlock' : 'ban'}"></i>
                    </button>
                    <button class="btn btn-sm ${user.sms_enabled ? 'btn-success' : 'btn-danger'}"
                        onclick="toggleSMS('${user.id}', this)"
                        title="Toggle SMS">
                        <i class="fas fa-sms"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="showUpdatePasswordModal('${user.id}')" title="Update Password">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="showEmailModal('${user.id}', '${user.email}')" title="Update Email">
                        <i class="fas fa-envelope"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="forceLogoutUser('${user.id}')" title="Force Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="resetSMSCounter('${user.senderPhone}', '${user.fullName}', ${user.id})" title="Reset SMS Counter">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" 
                            onclick="showPhoneTransferModal('${user.id}', '${user.email}', '${user.fullName}', '${user.senderPhone || ''}', '${user.companyName || ''}')" 
                            title="Transfer Phone Number"
                            ${!user.senderPhone ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')" title="Delete User">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;

        // Enhanced SMS counter display (same as before)
        if (user.senderPhone) {
            const phone = user.senderPhone.replace(/[^\d]/g, '');
            fetch(`https://bkpmanual.bitnexdial.com/api/sms-counter-user?number=${phone}`)
                .then(res => res.json())
                .then(data => {
                    const smsCell = document.getElementById(`sms-${user.id}`);
                    if (smsCell) {
                        smsCell.innerHTML = `
                            <div class="sms-counter">
                                <div class="sms-total">${data.total}</div>
                                <div class="sms-breakdown">${data.sms} SMS  ${data.mms} MMS</div>
                            </div>
                        `;
                    }
                })
                .catch(err => {
                    const smsCell = document.getElementById(`sms-${user.id}`);
                    if (smsCell) {
                        smsCell.innerHTML = `
                            <div class="sms-counter">
                                <div class="sms-total"></div>
                                <div class="sms-breakdown">No data</div>
                            </div>
                        `;
                    }
                });
        } else {
            const smsCell = document.getElementById(`sms-${user.id}`);
            if (smsCell) {
                smsCell.innerHTML = `
                    <div class="sms-counter">
                        <div class="sms-total"></div>
                        <div class="sms-breakdown">No phone</div>
                    </div>
                `;
            }
        }
    });
}


/////////////function for delete and trnasfer ext
// Add these functions to your admin.html file's <script> section

// ===== PHONE NUMBER TRANSFER FUNCTIONS =====

// Show phone transfer modal for a specific user
// Add these functions to your admin.html file's <script> section

// ===== PHONE NUMBER TRANSFER FUNCTIONS =====

// Show phone transfer modal for a specific user
function showPhoneTransferModal(userId, currentEmail, currentFullName, currentPhone, currentCompany) {
    // Create phone transfer modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.id = 'phoneTransferModal';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; width: 90%;">
            <button class="modal-close" onclick="closePhoneTransferModal()">&times;</button>
            <h3 class="modal-title">
                <i class="fas fa-exchange-alt" style="color: var(--warning);"></i>
                Transfer Phone Number
            </h3>
            
            <div style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
                <strong> Important Notice</strong><br>
                This process will:<br>
                 Delete ALL data (SMS, calls, voicemails, recordings) for this phone number<br>
                 Update user credentials (email, password, name, company)<br>
                 Force logout the user immediately<br>
                 <strong>This action cannot be undone!</strong>
            </div>

            <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700);">
                    <i class="fas fa-user"></i> Current User Information
                </h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                    <div><strong>Email:</strong> ${currentEmail}</div>
                    <div><strong>Phone:</strong> ${currentPhone}</div>
                    <div><strong>Name:</strong> ${currentFullName}</div>
                    <div><strong>Company:</strong> ${currentCompany || 'Not set'}</div>
                </div>
            </div>

            <form id="phoneTransferForm">
                <input type="hidden" id="transferUserId" value="${userId}">
                <input type="hidden" id="transferCurrentPhone" value="${currentPhone}">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i>
                            New Email Address
                        </label>
                        <input type="email" class="form-input" id="transferNewEmail" placeholder="newuser@company.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i>
                            New Password
                        </label>
                        <input type="text" class="form-input" id="transferNewPassword" placeholder="Enter new password" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i>
                            New Full Name
                        </label>
                        <input type="text" class="form-input" id="transferNewFullName" placeholder="John Doe" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-building"></i>
                            New Company Name
                        </label>
                        <input type="text" class="form-input" id="transferNewCompany" placeholder="Company Inc.">
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button type="button" class="btn btn-info" onclick="previewPhoneCleanup('${currentPhone}')">
                        <i class="fas fa-eye"></i>
                        Preview Data to Delete
                    </button>
                    <button type="button" class="btn btn-warning" onclick="testCleanupOnly('${currentPhone}')">
                        <i class="fas fa-trash"></i>
                        Clean Data Only (No Transfer)
                    </button>
                </div>

                <div class="form-actions" style="border-top: 1px solid var(--gray-200); padding-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closePhoneTransferModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exchange-alt"></i>
                        Transfer Phone Number
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add form submit handler
    document.getElementById('phoneTransferForm').addEventListener('submit', handlePhoneTransfer);
    
    // Focus on first input
    setTimeout(() => {
        document.getElementById('transferNewEmail').focus();
    }, 100);
}

// Close phone transfer modal
function closePhoneTransferModal() {
    const modal = document.getElementById('phoneTransferModal');
    if (modal) {
        modal.remove();
    }
}

// Preview what data will be deleted for a phone number
async function previewPhoneCleanup(phoneNumber) {
    if (!phoneNumber) {
        showNotification("No phone number provided", "error");
        return;
    }

    try {
        const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/preview-phone-cleanup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phoneNumber: phoneNumber })
        });

        const result = await response.json();
        
        if (!response.ok) {
            showNotification(`Preview failed: ${result.error}`, "error");
            return;
        }

        const preview = result.preview;
        
        // Create preview modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        let dataRows = '';
        if (preview.dataToDelete) {
            dataRows = Object.entries(preview.dataToDelete).map(([key, count]) => {
                const labels = {
                    smsMessages: 'SMS Messages',
                    callRecords: 'Call Records',
                    smsCounterRecords: 'SMS Counter Records',
                    contacts: 'Contacts',
                    favoriteChats: 'Favorite Chats',
                    voicemailFiles: 'Voicemail Files',
                    callRecordings: 'Call Recordings'
                };
                
                return `
                    <tr style="${count > 0 ? 'background: rgba(239, 68, 68, 0.05);' : ''}">
                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200);">
                            ${labels[key] || key}
                        </td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right; font-weight: 600; font-family: 'JetBrains Mono', monospace;">
                            ${count}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                <h3 class="modal-title">
                    <i class="fas fa-eye" style="color: var(--info);"></i>
                    Data Cleanup Preview
                </h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="background: rgba(6, 182, 212, 0.1); border-left: 4px solid var(--info); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <strong> Phone Number:</strong> ${preview.phoneNumber}<br>
                        <strong> Normalized:</strong> ${preview.cleanPhone}<br>
                        <strong> Total Items:</strong> ${preview.summary ? preview.summary.totalItemsToDelete : 0}
                    </div>
                </div>

                <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--border-radius); overflow: hidden; margin-bottom: 1.5rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-100);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--gray-200);">Data Type</th>
                                <th style="padding: 1rem; text-align: right; font-weight: 600; border-bottom: 2px solid var(--gray-200);">Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dataRows}
                        </tbody>
                    </table>
                </div>

                ${preview.errors && preview.errors.length > 0 ? `
                    <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <strong> Errors encountered:</strong><br>
                        ${preview.errors.map(error => ` ${error}`).join('<br>')}
                    </div>
                ` : ''}

                <div style="text-align: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                    ${preview.summary && preview.summary.totalItemsToDelete > 0 ? `
                        <div style="color: var(--danger); font-weight: 600; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${preview.summary.totalItemsToDelete} items will be permanently deleted
                        </div>
                    ` : `
                        <div style="color: var(--success); font-weight: 600; margin-bottom: 1rem;">
                            <i class="fas fa-check-circle"></i>
                            No data found for this phone number
                        </div>
                    `}
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                        Close Preview
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error previewing cleanup:", error);
        showNotification("Failed to preview cleanup data", "error");
    }
}

// Clean data only (without transferring to new user)
async function testCleanupOnly(phoneNumber) {
    if (!phoneNumber) {
        showNotification("No phone number provided", "error");
        return;
    }

    const confirmation = prompt(
        ` DESTRUCTIVE ACTION WARNING\n\n` +
        `This will permanently delete ALL data for phone number: ${phoneNumber}\n\n` +
        `Including:\n` +
        ` All SMS messages\n` +
        ` All call records\n` +
        ` All voicemails\n` +
        ` All call recordings\n` +
        ` All contacts\n` +
        ` SMS usage counters\n\n` +
        `This action CANNOT be undone!\n\n` +
        `Type "DELETE_ALL_DATA" to confirm:`
    );

    if (confirmation !== "DELETE_ALL_DATA") {
        showNotification("Data cleanup cancelled", "info");
        return;
    }

    try {
        const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/clean-phone-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                phoneNumber: phoneNumber,
                confirm: "DELETE_ALL_DATA"
            })
        });

        const result = await response.json();
        
        if (response.ok) {
            showNotification(`Data cleanup completed: ${result.summary.totalItemsDeleted} items deleted`, "success");
            
            // Show detailed results
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let resultsHtml = Object.entries(result.results).map(([key, value]) => {
                if (key === 'errors' && Array.isArray(value)) {
                    return value.length > 0 ? `
                        <div style="color: var(--danger); margin: 0.5rem 0;">
                            <strong>Errors:</strong> ${value.join(', ')}
                        </div>
                    ` : '';
                }
                return `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-200);">
                        <span>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</span>
                        <strong>${value}</strong>
                    </div>
                `;
            }).join('');

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h3 class="modal-title">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        Cleanup Completed
                    </h3>
                    
                    <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--success); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                        <strong> Data cleanup successful for ${result.phoneNumber}</strong><br>
                        Total items deleted: ${result.summary.totalItemsDeleted}
                    </div>

                    <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--border-radius); padding: 1rem;">
                        ${resultsHtml}
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove(); fetchUsers();">
                            <i class="fas fa-sync-alt"></i>
                            Close & Refresh
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            closePhoneTransferModal();
            
        } else {
            showNotification(`Cleanup failed: ${result.error}`, "error");
        }
    } catch (error) {
        console.error("Error during cleanup:", error);
        showNotification("Failed to clean phone data", "error");
    }
}

// Handle phone transfer form submission
// Replace the handlePhoneTransfer function in admin.html with this corrected version
// FIXED: Replace the handlePhoneTransfer function in admin.html

async function handlePhoneTransfer(event) {
    event.preventDefault();
    
    const userId = document.getElementById('transferUserId').value;
    const phoneNumber = document.getElementById('transferCurrentPhone').value;
    const newEmail = document.getElementById('transferNewEmail').value.trim();
    const newPassword = document.getElementById('transferNewPassword').value.trim();
    const newFullName = document.getElementById('transferNewFullName').value.trim();
    const newCompanyName = document.getElementById('transferNewCompany').value.trim();
    
    // Validation
    if (!newEmail || !newPassword || !newFullName) {
        showNotification("Please fill in all required fields", "error");
        return;
    }
    
    if (!newEmail.includes('@')) {
        showNotification("Please enter a valid email address", "error");
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification("Password must be at least 6 characters long", "error");
        return;
    }

    const confirmation = prompt(
        ` PHONE NUMBER TRANSFER CONFIRMATION\n\n` +
        `This will:\n` +
        `1. DELETE ALL data for phone: ${phoneNumber}\n` +
        `2. Transfer phone to: ${newFullName} (${newEmail})\n` +
        `3. Force logout current user\n\n` +
        ` THIS ACTION CANNOT BE UNDONE!\n\n` +
        `Type "TRANSFER" to confirm:`
    );

    if (confirmation !== "TRANSFER") {
        showNotification("Phone transfer cancelled", "info");
        return;
    }

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalHTML = submitBtn.innerHTML;
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading"></div> Processing Transfer...';
        
        // FIXED: Call the transfer endpoint directly - it handles both cleanup and transfer
        const transferResponse = await fetch("https://bkpmanual.bitnexdial.com/api/admin/transfer-phone-number", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId: userId,
                newEmail: newEmail,
                newPassword: newPassword,
                newFullName: newFullName,
                newCompanyName: newCompanyName,
                phoneNumber: phoneNumber
            })
        });

        const transferResult = await transferResponse.json();
        
        if (!transferResponse.ok) {
            throw new Error(`Transfer failed: ${transferResult.error}`);
        }
        
        showNotification(`Phone number successfully transferred to ${newFullName}`, "success");
        
        // Show success modal with details
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const deletionSummary = transferResult.transfer.deletionSummary || {};
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transfer Completed Successfully
                </h3>
                
                <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--success); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
                    <strong> Phone number ${phoneNumber} has been successfully transferred!</strong>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--border-radius);">
                        <h4 style="margin-bottom: 1rem; color: var(--gray-700);"> Data Cleanup Results</h4>
                        <div style="font-size: 0.875rem;">
                            <div>SMS Messages: <strong>${deletionSummary.smsMessages || 0}</strong></div>
                            <div>Call Records: <strong>${deletionSummary.callRecords || 0}</strong></div>
                            <div>Recordings: <strong>${deletionSummary.recordings || 0}</strong></div>
                            <div>Voicemails: <strong>${deletionSummary.voicemails || 0}</strong></div>
                            <div>Contacts: <strong>${deletionSummary.contacts || 0}</strong></div>
                            <div>SMS Counters: <strong>${deletionSummary.smsCounterRecords || 0}</strong></div>
                            <div>Favorite Chats: <strong>${deletionSummary.favoriteChats || 0}</strong></div>
                            <div style="border-top: 1px solid var(--gray-300); margin-top: 0.5rem; padding-top: 0.5rem; font-weight: 600;">
                                Total Deleted: <strong>${Object.values(deletionSummary).reduce((sum, val) => sum + (typeof val === 'number' ? val : 0), 0)}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--border-radius);">
                        <h4 style="margin-bottom: 1rem; color: var(--gray-700);"> New User Details</h4>
                        <div style="font-size: 0.875rem;">
                            <div>Email: <strong>${transferResult.transfer.newEmail}</strong></div>
                            <div>Name: <strong>${transferResult.transfer.newFullName}</strong></div>
                            <div>Company: <strong>${transferResult.transfer.newCompanyName}</strong></div>
                            <div>Phone: <strong>${transferResult.transfer.phoneNumber}</strong></div>
                            <div>Extension: <strong>${transferResult.transfer.extension}</strong></div>
                            <div style="border-top: 1px solid var(--gray-300); margin-top: 0.5rem; padding-top: 0.5rem; color: var(--gray-600);">
                                Transferred: <strong>${new Date(transferResult.transfer.transferredAt).toLocaleString()}</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(6, 182, 212, 0.1); border-left: 4px solid var(--info); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
                    <strong> Next Steps:</strong><br>
                     The user has been forced to logout and must login with new credentials<br>
                     Phone number ${phoneNumber} is now clean and ready for the new user<br>
                     All SIP settings and configurations remain unchanged<br>
                     Extension-specific data (recordings/voicemails) has been properly cleaned
                </div>

                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove(); closePhoneTransferModal(); fetchUsers();">
                        <i class="fas fa-sync-alt"></i>
                        Close & Refresh Users
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error during phone transfer:", error);
        showNotification(`Transfer failed: ${error.message}`, "error");
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
    }
}
// Modify the existing displayUsers function to include transfer button
function addTransferButtonToUserActions(user) {
    // This should be added to the actions column in displayUsers function
    return `
        <button class="btn btn-sm btn-warning" 
                onclick="showPhoneTransferModal('${user.id}', '${user.email}', '${user.fullName}', '${user.senderPhone || ''}', '${user.companyName || ''}')" 
                title="Transfer Phone Number"
                ${!user.senderPhone ? 'disabled' : ''}>
            <i class="fas fa-exchange-alt"></i>
        </button>
    `;
}

console.log(' Phone transfer UI functions added successfully');


// Close phone transfer modal
function closePhoneTransferModal() {
    const modal = document.getElementById('phoneTransferModal');
    if (modal) {
        modal.remove();
    }
}

// Preview what data will be deleted for a phone number
async function previewPhoneCleanup(phoneNumber) {
    if (!phoneNumber) {
        showNotification("No phone number provided", "error");
        return;
    }

    try {
        const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/preview-phone-cleanup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phoneNumber: phoneNumber })
        });

        const result = await response.json();
        
        if (!response.ok) {
            showNotification(`Preview failed: ${result.error}`, "error");
            return;
        }

        const preview = result.preview;
        
        // Create preview modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        let dataRows = '';
        if (preview.dataToDelete) {
            dataRows = Object.entries(preview.dataToDelete).map(([key, count]) => {
                const labels = {
                    smsMessages: 'SMS Messages',
                    callRecords: 'Call Records',
                    smsCounterRecords: 'SMS Counter Records',
                    contacts: 'Contacts',
                    favoriteChats: 'Favorite Chats',
                    voicemailFiles: 'Voicemail Files',
                    callRecordings: 'Call Recordings'
                };
                
                return `
                    <tr style="${count > 0 ? 'background: rgba(239, 68, 68, 0.05);' : ''}">
                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200);">
                            ${labels[key] || key}
                        </td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right; font-weight: 600; font-family: 'JetBrains Mono', monospace;">
                            ${count}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                <h3 class="modal-title">
                    <i class="fas fa-eye" style="color: var(--info);"></i>
                    Data Cleanup Preview
                </h3>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="background: rgba(6, 182, 212, 0.1); border-left: 4px solid var(--info); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <strong> Phone Number:</strong> ${preview.phoneNumber}<br>
                        <strong> Normalized:</strong> ${preview.cleanPhone}<br>
                        <strong> Total Items:</strong> ${preview.summary ? preview.summary.totalItemsToDelete : 0}
                    </div>
                </div>

                <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--border-radius); overflow: hidden; margin-bottom: 1.5rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-100);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--gray-200);">Data Type</th>
                                <th style="padding: 1rem; text-align: right; font-weight: 600; border-bottom: 2px solid var(--gray-200);">Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dataRows}
                        </tbody>
                    </table>
                </div>

                ${preview.errors && preview.errors.length > 0 ? `
                    <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <strong> Errors encountered:</strong><br>
                        ${preview.errors.map(error => ` ${error}`).join('<br>')}
                    </div>
                ` : ''}

                <div style="text-align: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                    ${preview.summary && preview.summary.totalItemsToDelete > 0 ? `
                        <div style="color: var(--danger); font-weight: 600; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${preview.summary.totalItemsToDelete} items will be permanently deleted
                        </div>
                    ` : `
                        <div style="color: var(--success); font-weight: 600; margin-bottom: 1rem;">
                            <i class="fas fa-check-circle"></i>
                            No data found for this phone number
                        </div>
                    `}
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                        Close Preview
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error previewing cleanup:", error);
        showNotification("Failed to preview cleanup data", "error");
    }
}

// Clean data only (without transferring to new user)
async function testCleanupOnly(phoneNumber) {
    if (!phoneNumber) {
        showNotification("No phone number provided", "error");
        return;
    }

    const confirmation = prompt(
        ` DESTRUCTIVE ACTION WARNING\n\n` +
        `This will permanently delete ALL data for phone number: ${phoneNumber}\n\n` +
        `Including:\n` +
        ` All SMS messages\n` +
        ` All call records\n` +
        ` All voicemails\n` +
        ` All call recordings\n` +
        ` All contacts\n` +
        ` SMS usage counters\n\n` +
        `This action CANNOT be undone!\n\n` +
        `Type "DELETE" to confirm:`
    );

    if (confirmation !== "DELETE") {
        showNotification("Data cleanup cancelled", "info");
        return;
    }

    try {
        const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/clean-phone-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                phoneNumber: phoneNumber,
                confirm: "DELETE"
            })
        });

        const result = await response.json();
        
        if (response.ok) {
            showNotification(`Data cleanup completed: ${result.summary.totalItemsDeleted} items deleted`, "success");
            
            // Show detailed results
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let resultsHtml = Object.entries(result.results).map(([key, value]) => {
                if (key === 'errors' && Array.isArray(value)) {
                    return value.length > 0 ? `
                        <div style="color: var(--danger); margin: 0.5rem 0;">
                            <strong>Errors:</strong> ${value.join(', ')}
                        </div>
                    ` : '';
                }
                return `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-200);">
                        <span>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</span>
                        <strong>${value}</strong>
                    </div>
                `;
            }).join('');

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h3 class="modal-title">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        Cleanup Completed
                    </h3>
                    
                    <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--success); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                        <strong> Data cleanup successful for ${result.phoneNumber}</strong><br>
                        Total items deleted: ${result.summary.totalItemsDeleted}
                    </div>

                    <div style="background: var(--white); border: 1px solid var(--gray-200); border-radius: var(--border-radius); padding: 1rem;">
                        ${resultsHtml}
                    </div>

                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove(); fetchUsers();">
                            <i class="fas fa-sync-alt"></i>
                            Close & Refresh
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            closePhoneTransferModal();
            
        } else {
            showNotification(`Cleanup failed: ${result.error}`, "error");
        }
    } catch (error) {
        console.error("Error during cleanup:", error);
        showNotification("Failed to clean phone data", "error");
    }
}


// Add transfer button to user actions in the displayUsers function
// Modify the existing displayUsers function to include transfer button
function addTransferButtonToUserActions(user) {
    // This should be added to the actions column in displayUsers function
    return `
        <button class="btn btn-sm btn-warning" 
                onclick="showPhoneTransferModal('${user.id}', '${user.email}', '${user.fullName}', '${user.senderPhone || ''}', '${user.companyName || ''}')" 
                title="Transfer Phone Number"
                ${!user.senderPhone ? 'disabled' : ''}>
            <i class="fas fa-exchange-alt"></i>
        </button>
    `;
}

console.log(' Phone transfer UI functions added successfully');

        // Continue with session fetching and other functions...
        async function fetchSessions() {
            try {
                // Try the detailed endpoint first
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/sessions-detailed");
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                
                sessionsData = JSON.parse(responseText);
                
                displaySessions(sessionsData);
            } catch (error) {
                console.error(" Failed to fetch sessions from detailed API:", error);
                try {
                    const fallbackResponse = await fetch("https://bkpmanual.bitnexdial.com/api/sessions");
                    
                    if (!fallbackResponse.ok) {
                        throw new Error(`HTTP ${fallbackResponse.status}: ${fallbackResponse.statusText}`);
                    }
                    
                    const fallbackText = await fallbackResponse.text();
                    
                    sessionsData = JSON.parse(fallbackText);
                    
                    displaySessions(sessionsData);
                } catch (fallbackError) {
                    console.error(" Fallback fetch also failed:", fallbackError);
                    showNotification("Failed to fetch sessions data from all endpoints", "error");
                    
                    // Display error state
                    const tbody = document.getElementById("sessionsTable").querySelector("tbody");
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block; color: var(--danger);"></i>
                                <strong>Failed to load sessions data</strong><br>
                                <small>Please check the console for detailed error information</small><br>
                                <button class="btn btn-primary" onclick="fetchSessions()" style="margin-top: 1rem;">
                                    <i class="fas fa-sync-alt"></i> Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function displaySessions(sessions) {
            const tbody = document.getElementById("sessionsTable").querySelector("tbody");
            
            if (!tbody) {
                console.error(' Sessions table body not found!');
                return;
            }
            
            tbody.innerHTML = "";

            if (!sessions || sessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                            <i class="fas fa-wifi" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                            No active sessions found
                        </td>
                    </tr>
                `;
                return;
            }

            sessions.forEach((session, index) => {                
                const row = tbody.insertRow();
                const initials = session.fullName ? session.fullName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="avatar status-online">${initials}</div>
                            <div class="user-details">
                                <h4>${session.fullName || 'Unknown User'}</h4>
                                <p>${session.email || 'No email'}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="sip-username">
                            ${session.extension || 'N/A'}
                        </div>
                    </td>
                    <td>
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: rgba(99, 102, 241, 0.1); padding: 0.25rem 0.5rem; border-radius: 4px;" title="Full Session ID: ${session.sessionId || session.session_id || 'N/A'}">
                            ${(session.sessionId || session.session_id || 'N/A').substring(0, 12)}...
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-success">Active</span>
                    </td>
                    <td>
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;">
                            ${session.session_login_time?.replace("T", " ").substring(0, 19) || session.loginTime || ""}
                        </div>
                    </td>
                    <td>
                        <div class="actions">
                            <button 
                                class="btn btn-sm btn-warning" 
                                onclick="forceLogoutSession('${session.sessionId || session.session_id || session.id}', '${session.fullName || 'Unknown User'}')"
                                title="Force logout this session"
                            >
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
            });

        }

        // Enhanced stats update
        function updateStats() {
            document.getElementById('totalUsers').textContent = usersData.length;
            document.getElementById('activeUsers').textContent = usersData.filter(u => u.status !== 'banned').length;
            document.getElementById('onlineDevices').textContent = onlineDevicesData.length;
            document.getElementById('onlineSessions').textContent = sessionsData.length;
        }

        // Enhanced search functionality
        function filterTable(tableId, searchText) {
            const input = searchText.toLowerCase();
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll("tbody tr");

            rows.forEach(row => {
                const rowText = row.innerText.toLowerCase();
                const isVisible = rowText.includes(input);
                row.style.display = isVisible ? "" : "none";
                
                if (isVisible && input) {
                    row.style.background = 'rgba(99, 102, 241, 0.1)';
                } else {
                    row.style.background = '';
                }
            });
        }

        // Modal functions
        function showUpdatePasswordModal(userId) {
            currentUpdatingUserId = userId;
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('newPassword').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            currentUpdatingUserId = null;
            document.getElementById('newPassword').value = '';
        }

        function showEmailModal(userId, currentEmail) {
            document.getElementById('updateEmailUserId').value = userId;
            document.getElementById('newEmail').value = currentEmail;
            document.getElementById('emailModal').style.display = 'flex';
            document.getElementById('newEmail').focus();
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
            document.getElementById('newEmail').value = '';
        }

        function showCreateUserModal() {
            switchTab('create-user');
            document.getElementById('email').focus();
        }

        // Enhanced password display functions
        function togglePassword(userId, password) {
            const span = document.getElementById(`pwd-${userId}`);
            const btn = span.nextElementSibling;
            const icon = btn.querySelector('i');
            
            if (span.innerText === "") {
                span.innerText = password;
                span.style.fontFamily = "'JetBrains Mono', monospace";
                icon.className = "fas fa-eye-slash";
                btn.title = "Hide password";
            } else {
                span.innerText = "";
                span.style.fontFamily = "inherit";
                icon.className = "fas fa-eye";
                btn.title = "Show password";
            }
        }

        function copyPassword(password) {
            if (!password) {
                showNotification("No password available to copy", "warning");
                return;
            }
            
            navigator.clipboard.writeText(password).then(() => {
                showNotification("Password copied to clipboard successfully!", "success");
            }).catch(err => {
                console.error("Copy failed:", err);
                showNotification("Failed to copy password to clipboard", "error");
            });
        }

        // API Functions with enhanced error handling
        async function toggleBan(userId, button) {
            const originalHTML = button.innerHTML;
            const originalTitle = button.title;
            
            try {
                button.disabled = true;
                button.innerHTML = '<div class="loading"></div>';
                button.title = 'Processing...';
                
                const response = await fetch(`https://bkpmanual.bitnexdial.com/api/admin/toggle-ban/${userId}`, {
                    method: "PUT"
                });
                const result = await response.json();
                showNotification(result.message, response.ok ? "success" : "error");
                if (response.ok) fetchUsers();
            } catch (error) {
                console.error("Error toggling ban:", error);
                showNotification("Failed to update user status", "error");
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
                button.title = originalTitle;
            }
        }

        async function toggleSMS(userId, button) {
            const originalHTML = button.innerHTML;
            const originalTitle = button.title;
            
            try {
                button.disabled = true;
                button.innerHTML = '<div class="loading"></div>';
                button.title = 'Processing...';

                const response = await fetch(`https://bkpmanual.bitnexdial.com/api/admin/toggle-sms/${userId}`, {
                    method: "PUT"
                });
                const result = await response.json();
                showNotification(result.message, response.ok ? "success" : "error");
                if (response.ok) fetchUsers();
            } catch (error) {
                console.error("Error toggling SMS:", error);
                showNotification("Failed to toggle SMS settings", "error");
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
                button.title = originalTitle;
            }
        }

        async function forceLogoutUser(userId) {
            if (!confirm(" Force Logout Confirmation\n\nThis will immediately terminate all active sessions for this user.\n\nAre you sure you want to continue?")) return;

            try {
                const response = await fetch(`https://bkpmanual.bitnexdial.com/api/admin/force-logout/${userId}`, {
                    method: "PUT"
                });
                const result = await response.json();
                showNotification(result.message, response.ok ? "success" : "error");
                if (response.ok) {
                    fetchUsers();
                    fetchSessions();
                }
            } catch (error) {
                console.error("Error forcing logout:", error);
                showNotification("Failed to force logout user", "error");
            }
        }

        async function deleteUser(userId) {
            if (!confirm(" DELETE USER CONFIRMATION\n\nThis action will permanently delete this user account and cannot be undone.\n\nAll user data, sessions, and configurations will be lost.\n\nType 'DELETE' to confirm this action.")) return;
            
            const confirmation = prompt("Please type 'DELETE' to confirm user deletion:");
            if (confirmation !== 'DELETE') {
                showNotification("User deletion cancelled", "info");
                return;
            }

            try {
                const response = await fetch(`https://bkpmanual.bitnexdial.com/api/admin/delete/${userId}`, {
                    method: "DELETE"
                });
                const result = await response.json();
                showNotification(result.message, response.ok ? "success" : "error");
                if (response.ok) {
                    fetchUsers();
                    fetchSessions();
                }
            } catch (error) {
                console.error("Error deleting user:", error);
                showNotification("Failed to delete user", "error");
            }
        }

        async function resetSMSCounter(phone, name, userId) {
            if (!phone) {
                showNotification("No phone number configured for this user", "warning");
                return;
            }

            if (!confirm(` Reset SMS Counter\n\nThis will reset the SMS usage counter to zero for ${name}.\n\nAre you sure you want to continue?`)) return;

            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/reset-sms-counter", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ number: phone })
                });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, "success");
                    const smsCell = document.getElementById(`sms-${userId}`);
                    if (smsCell) {
                        smsCell.innerHTML = `
                            <div class="sms-counter">
                                <div class="sms-total">0</div>
                                <div class="sms-breakdown">0 SMS  0 MMS</div>
                            </div>
                        `;
                    }
                } else {
                    showNotification("Reset failed: " + result.error, "error");
                }
            } catch (error) {
                console.error("Reset error:", error);
                showNotification("Failed to reset SMS counter", "error");
            }
        }

        function changeUserDomain(userId, newDomain) {
            const domainInput = document.getElementById('domain');
            const wssInput = document.getElementById('secureWebSocketServer');
            domainInput.value = newDomain;
            wssInput.value = newDomain;
            showNotification(`Default domain updated to: ${newDomain}`, "success");
        }

        // Session management functions
        async function forceLogoutSession(sessionId, userName) {
            if (!confirm(` Force Logout Session\n\nThis will immediately terminate the session for ${userName}.\n\nAre you sure you want to continue?`)) return;

            try {
                const response = await fetch(`https://bkpmanual.bitnexdial.com/api/force-logout-session`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sessionId })
                });
                const result = await response.json();
                showNotification(result.message, response.ok ? "success" : "error");
                if (response.ok) {
                    fetchSessions();
                    fetchUsers();
                }
            } catch (error) {
                console.error("Error forcing logout session:", error);
                showNotification("Failed to logout session", "error");
            }
        }

        // Real-time monitoring functions
        function startDeviceMonitoring() {
            setInterval(async () => {
                try {
                    // Only refresh if devices tab is active
                    if (document.getElementById('devices-tab').classList.contains('active')) {
                        await fetchOnlineDevices();
                    }
                } catch (error) {
                    console.error("Device monitoring error:", error);
                }
            }, 30000); // Check every 30 seconds
        }

        function startSessionMonitoring() {
            setInterval(async () => {
                try {
                    // Only refresh if sessions tab is active
                    if (document.getElementById('sessions-tab').classList.contains('active')) {
                        await fetchSessions();
                    }
                } catch (error) {
                    console.error("Session monitoring error:", error);
                }
            }, 60000); // Check every minute
        }

        // Utility functions
        function refreshData() {
            showNotification("Refreshing dashboard data...", "info");
            const promises = [fetchUsers()];
            
            // Only fetch additional data if the respective tabs are active or have been loaded
            if (document.getElementById('devices-tab').classList.contains('active') || onlineDevicesData.length > 0) {
                promises.push(fetchOnlineDevices());
            }
            
            if (document.getElementById('sessions-tab').classList.contains('active') || sessionsData.length > 0) {
                promises.push(fetchSessions());
            }
            
            Promise.all(promises)
                .then(() => {
                    showNotification("Dashboard data refreshed successfully!", "success");
                })
                .catch(() => {
                    showNotification("Failed to refresh some data", "warning");
                });
        }

        // Show user devices and allow selective kicking
        async function showUserDevices(aor, userName) {
            try {
                const response = await fetch(`https://bkpmanual.bitnexdial.com/api/pjsip-user-contacts/${aor}`);
                const result = await response.json();
                
                if (!response.ok) {
                    showNotification(`Failed to fetch devices for ${userName}`, "error");
                    return;
                }

                if (result.total_devices === 0) {
                    showNotification(`${userName} has no registered devices`, "info");
                    return;
                }

                // Create device selection modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                
                let devicesHtml = result.contacts.map((device, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--gray-200); border-radius: var(--border-radius); margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem;">
                                ${device.contact}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">
                                Status: <span class="badge ${device.status === 'Avail' ? 'badge-success' : 'badge-danger'}">${device.status}</span>
                                ${device.rtt ? ` RTT: ${device.rtt}ms` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-warning" onclick="kickSpecificDevice('${device.contact}', '${aor}', '${userName}')">
                                <i class="fas fa-mobile-alt"></i> Ban Device
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="quickKickDevice('${device.contact}', '${aor}')">
                                <i class="fas fa-sign-out-alt"></i> Quick Kick
                            </button>
                        </div>
                    </div>
                `).join('');

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        <h3 class="modal-title">
                            <i class="fas fa-mobile-alt"></i>
                            ${userName} Devices (${result.total_devices}/5)
                        </h3>
                        <div style="margin-bottom: 1.5rem;">
                            ${result.total_devices > 5 ? `
                                <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                                    <strong> Device Limit Exceeded</strong><br>
                                    This user has ${result.total_devices} devices registered (limit: 5)
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-warning" onclick="kickExcessDevices('${aor}', '${userName}', 'worst_rtt')">
                                    <i class="fas fa-broom"></i> Auto-kick Worst Connections
                                </button>
                                <button class="btn btn-info" onclick="kickExcessDevices('${aor}', '${userName}', 'oldest')">
                                    <i class="fas fa-clock"></i> Auto-kick Oldest Devices
                                </button>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${devicesHtml}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error("Error fetching user devices:", error);
                showNotification("Failed to fetch user devices", "error");
            }
        }

        // Enhanced kick specific device with device-level ban (not user ban)
        async function kickSpecificDevice(contact, aor, userName) {
            const suspendDuration = prompt("Ban this specific device for how many seconds?\n(Enter 0 for immediate kick only, default: 300)", "300");
            if (suspendDuration === null) return; // User cancelled
            
            const duration = parseInt(suspendDuration) || 0;
            
            const actionText = duration > 0 
                ? `ban this specific device for ${duration} seconds`
                : `kick this specific device only (can reconnect immediately)`;
            
            if (!confirm(` Device-Specific Ban\n\nUser: ${userName}\nDevice: ${contact}\nAction: ${actionText}\n\n IMPORTANT: This will NOT affect other devices of the same user.\n\nAre you sure?`)) {
                return;
            }

            try {
                const endpoint = duration > 0 
                    ? "https://bkpmanual.bitnexdial.com/api/pjsip-kick-device-specific"
                    : "https://bkpmanual.bitnexdial.com/api/admin/pjsip-kick-specific-device";
                
                const body = duration > 0
                    ? { 
                        contact: contact, 
                        aor: aor, 
                        suspendDuration: duration,
                        reason: `Device-specific ban for excess device - User: ${userName}`
                      }
                    : { 
                        contact: contact, 
                        reason: `Device kick for user ${userName}` 
                      };

                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const result = await response.json();
                
                if (response.ok) {
                    const message = duration > 0 
                        ? `Device banned for ${duration} seconds (device-specific ban)`
                        : `Device kicked (can reconnect immediately)`;
                    showNotification(message, "success");
                    
                    // Close modal and refresh
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                    setTimeout(() => {
                        fetchOnlineDevices();
                    }, 1000);
                } else {
                    showNotification(`Failed to ban device: ${result.error}`, "error");
                }
            } catch (error) {
                console.error("Error banning specific device:", error);
                showNotification("Failed to ban device", "error");
            }
        }

        // Quick kick device without ban
        async function quickKickDevice(contact, aor) {
            if (!confirm(` Quick Kick Device\n\nDevice: ${contact}\nAOR: ${aor}\n\nThis will immediately disconnect the device (can reconnect immediately).\n\nAre you sure?`)) {
                return;
            }

            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/pjsip-kick-specific-device", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contact: contact,
                        reason: `Quick kick for AOR ${aor}`
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`Device kicked (can reconnect immediately)`, "success");
                    setTimeout(() => {
                        fetchOnlineDevices();
                    }, 1000);
                } else {
                    showNotification(`Failed to kick device: ${result.error}`, "error");
                }
            } catch (error) {
                console.error("Error quick kicking device:", error);
                showNotification("Failed to kick device", "error");
            }
        }

        // Auto-kick excess devices with strategy
        async function kickExcessDevices(aor, userName, strategy = 'worst_rtt') {
            const strategyNames = {
                'worst_rtt': 'worst connections (highest RTT)',
                'oldest': 'oldest registered devices'
            };

            if (!confirm(` Auto-kick Excess Devices\n\nUser: ${userName}\nStrategy: Keep 5 best devices, kick ${strategyNames[strategy]}\n\nThis will automatically kick excess devices.\n\nAre you sure?`)) {
                return;
            }

            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/pjsip-kick-user-excess", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        aor: aor,
                        maxDevices: 5,
                        kickStrategy: strategy
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`${result.message} (${result.devicesKicked} devices kicked)`, "success");
                    // Close modal and refresh
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                    setTimeout(() => {
                        fetchOnlineDevices();
                    }, 1000);
                } else {
                    showNotification(`Failed to kick excess devices: ${result.error}`, "error");
                }
            } catch (error) {
                console.error("Error kicking excess devices:", error);
                showNotification("Failed to kick excess devices", "error");
            }
        }

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                sessionStorage.removeItem("loggedIn");
                showNotification("Logging out...", "info");
                setTimeout(() => {
                    window.location.href = "/login.html";
                }, 1500);
            }
        }

        // Manual unban user function
        async function unbanUser(userId, fullName, sipUsername) {
            if (!confirm(` Unban User Confirmation\n\nUser: ${fullName}\nSIP Username: ${sipUsername}\n\nThis will immediately restore access for this user.\n\nAre you sure you want to unban this user?`)) {
                return;
            }

            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/unban-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        userId: userId,
                        aor: sipUsername,
                        reason: `Manual unban by admin`
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`User ${fullName} has been unbanned successfully`, "success");
                    // Refresh the users list
                    setTimeout(() => {
                        fetchUsers();
                    }, 1000);
                } else {
                    showNotification(`Failed to unban user: ${result.error}`, "error");
                }
            } catch (error) {
                console.error("Error unbanning user:", error);
                showNotification("Failed to unban user", "error");
            }
        }

        // Show banned users in a modal
        async function showBannedUsers() {
            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/banned-users");
                const result = await response.json();
                
                if (!response.ok) {
                    showNotification("Failed to fetch banned users", "error");
                    return;
                }

                if (result.totalBanned === 0) {
                    showNotification("No banned users found", "info");
                    return;
                }

                // Create banned users modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                
                let bannedUsersHtml = result.bannedUsers.map(user => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--danger); border-radius: var(--border-radius); margin-bottom: 0.5rem; background: rgba(239, 68, 68, 0.05);">
                        <div>
                            <div style="font-weight: 600; font-size: 0.875rem; color: var(--gray-900);">
                                ${user.fullName || 'Unknown User'}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500);">
                                Email: ${user.email}<br>
                                SIP: ${user.sipUsername || 'N/A'}  Phone: ${user.senderPhone || 'N/A'}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-success" onclick="unbanUser('${user.id}', '${user.fullName}', '${user.sipUsername}')">
                            <i class="fas fa-unlock"></i> Unban
                        </button>
                    </div>
                `).join('');

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        <h3 class="modal-title">
                            <i class="fas fa-ban" style="color: var(--danger);"></i>
                            Banned Users (${result.totalBanned})
                        </h3>
                        <div style="margin-bottom: 1.5rem;">
                            <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                                <strong> Banned Users Management</strong><br>
                                These users are currently banned and cannot access the system.
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${bannedUsersHtml}
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); text-align: center;">
                            <button class="btn btn-info" onclick="this.closest('.modal').remove(); fetchUsers();">
                                <i class="fas fa-sync-alt"></i> Refresh Users List
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error("Error fetching banned users:", error);
                showNotification("Failed to fetch banned users", "error");
            }
        }

        // Show temporary bans in a modal
        async function showTempBans() {
            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/temp-bans");
                const result = await response.json();
                
                if (!response.ok) {
                    showNotification("Failed to fetch temporary bans", "error");
                    return;
                }

                if (result.totalActiveBans === 0) {
                    showNotification("No active temporary bans found", "info");
                    return;
                }

                // Create temp bans modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                
                let tempBansHtml = result.activeBans.map(ban => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--warning); border-radius: var(--border-radius); margin-bottom: 0.5rem; background: rgba(245, 158, 11, 0.05);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.875rem; color: var(--gray-900);">
                                AOR: ${ban.aor} (User ID: ${ban.userId})
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500); margin: 0.5rem 0;">
                                <strong>Reason:</strong> ${ban.reason}<br>
                                <strong>Banned At:</strong> ${new Date(ban.bannedAt).toLocaleString()}<br>
                                <strong>Contact:</strong> ${ban.contact}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--warning); font-weight: 600;">
                                <i class="fas fa-clock"></i> ${ban.timeRemainingDisplay} remaining
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-sm btn-success" onclick="unbanTempUser('${ban.userId}', '${ban.aor}')">
                                <i class="fas fa-unlock"></i> Unban Now
                            </button>
                            <div style="font-size: 0.75rem; text-align: center; color: var(--gray-500);">
                                Until: ${new Date(ban.bannedUntil).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `).join('');

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        <h3 class="modal-title">
                            <i class="fas fa-clock" style="color: var(--warning);"></i>
                            Active Temporary Bans (${result.totalActiveBans})
                        </h3>
                        <div style="margin-bottom: 1.5rem;">
                            <div style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--warning); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                                <strong> Temporary Bans Management</strong><br>
                                These users are temporarily banned and will be automatically restored. You can unban them early if needed.
                            </div>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-info" onclick="this.closest('.modal').remove(); showTempBans();">
                                    <i class="fas fa-sync-alt"></i> Refresh List
                                </button>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${tempBansHtml}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error("Error fetching temp bans:", error);
                showNotification("Failed to fetch temporary bans", "error");
            }
        }

        // Show device-specific bans in a modal
        async function showDeviceBans() {
            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/device-bans");
                const result = await response.json();
                
                if (!response.ok) {
                    showNotification("Failed to fetch device bans", "error");
                    return;
                }

                if (result.totalActiveBans === 0) {
                    showNotification("No active device bans found", "info");
                    return;
                }

                // Create device bans modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                
                let deviceBansHtml = result.activeBans.map(ban => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--info); border-radius: var(--border-radius); margin-bottom: 0.5rem; background: rgba(6, 182, 212, 0.05);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 0.875rem; color: var(--gray-900);">
                                Device: ${ban.contact}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500); margin: 0.5rem 0;">
                                <strong>AOR:</strong> ${ban.aor}<br>
                                <strong>Reason:</strong> ${ban.reason}<br>
                                <strong>Banned At:</strong> ${new Date(ban.bannedAt).toLocaleString()}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--info); font-weight: 600;">
                                <i class="fas fa-mobile-alt"></i> ${ban.timeRemainingDisplay} remaining
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <button class="btn btn-sm btn-success" onclick="unbanDevice('${ban.contact}')">
                                <i class="fas fa-unlock"></i> Unban Device
                            </button>
                            <div style="font-size: 0.75rem; text-align: center; color: var(--gray-500);">
                                Until: ${new Date(ban.bannedUntil).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `).join('');

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px;">
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        <h3 class="modal-title">
                            <i class="fas fa-mobile-alt" style="color: var(--info);"></i>
                            Banned Devices (${result.totalActiveBans})
                        </h3>
                        <div style="margin-bottom: 1.5rem;">
                            <div style="background: rgba(6, 182, 212, 0.1); border-left: 4px solid var(--info); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                                <strong> Device-Level Bans</strong><br>
                                These specific devices are banned and cannot register. Other devices from the same user can still work.
                            </div>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-info" onclick="this.closest('.modal').remove(); showDeviceBans();">
                                    <i class="fas fa-sync-alt"></i> Refresh List
                                </button>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${deviceBansHtml}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error("Error fetching device bans:", error);
                showNotification("Failed to fetch device bans", "error");
            }
        }

        // Unban a specific device early
        async function unbanDevice(contact) {
            if (!confirm(` Unban Device Confirmation\n\nDevice: ${contact}\n\nThis will immediately allow this specific device to register again.\n\nAre you sure you want to unban this device?`)) {
                return;
            }

            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/unban-device", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contact: contact,
                        reason: `Early device unban by admin`
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`Device ${contact} has been unbanned`, "success");
                    // Close modal and refresh
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                    setTimeout(() => {
                        fetchOnlineDevices();
                        showDeviceBans(); // Refresh the device bans list
                    }, 1000);
                } else {
                    showNotification(`Failed to unban device: ${result.error}`, "error");
                }
            } catch (error) {
                console.error("Error unbanning device:", error);
                showNotification("Failed to unban device", "error");
            }
        }

        // Unban a temporarily banned user early
        async function unbanTempUser(userId, aor) {
            if (!confirm(` Early Unban Confirmation\n\nUser: ${aor} (ID: ${userId})\n\nThis will immediately restore access for this temporarily banned user.\n\nAre you sure you want to unban early?`)) {
                return;
            }

            try {
                const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/unban-temp-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        userId: userId,
                        reason: `Early unban by admin for AOR ${aor}`
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`User ${aor} has been unbanned early`, "success");
                    // Close modal and refresh
                    const modal = document.querySelector('.modal');
                    if (modal) modal.remove();
                    setTimeout(() => {
                        fetchUsers();
                        showTempBans(); // Refresh the temp bans list
                    }, 1000);
                } else {
                    showNotification(`Failed to unban user: ${result.error}`, "error");
                }
            } catch (error) {
                console.error("Error unbanning temp user:", error);
                showNotification("Failed to unban user", "error");
            }
        }

        // Initialize application
        window.onload = function() {
            // Hide modals initially
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('emailModal').style.display = 'none';
            
            // Check if create user tab exists
            const createUserTab = document.getElementById('create-user-tab');
            if (createUserTab) {
                console.log('Create user tab found on load');
            } else {
                console.error('Create user tab NOT found on load');
            }
            
            // Load initial data
            fetchUsers();
            
            // Start monitoring
            startDeviceMonitoring();
            startSessionMonitoring();
            
            // Auto-refresh users data every 2 minutes
            setInterval(() => {
                fetchUsers();
            }, 120000);

            // Welcome message
            setTimeout(() => {
                showNotification("Welcome to BitNex Admin Dashboard! All systems operational.", "success");
            }, 1000);
        };

        // Form event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Create user form
            document.getElementById('createUserForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalHTML = submitBtn.innerHTML;
                
                const user = {
                    email: document.getElementById("email").value,
                    password: document.getElementById("password").value,
                    fullName: document.getElementById("fullName").value,
                    companyName: document.getElementById("companyName").value,
                    domain: document.getElementById("domain").value,
                    sipUsername: document.getElementById("sipUsername").value,
                    sipPassword: document.getElementById("sipPassword").value,
                    secureWebSocketServer: document.getElementById("secureWebSocketServer").value,
                    webSocketPort: document.getElementById("webSocketPort").value,
                    webSocketPath: document.getElementById("webSocketPath").value,
                    role: document.getElementById("role").value,
                    senderPhone: document.getElementById("senderPhone").value,
                };

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="loading"></div> Creating...';
                    
                    const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/create", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(user)
                    });
                    const result = await response.json();
                    showNotification(result.message, response.ok ? "success" : "error");
                    if (response.ok) {
                        fetchUsers();
                        document.getElementById("createUserForm").reset();
                        showNotification("User created successfully! Refreshing user list...", "success");
                    }
                } catch (error) {
                    console.error("Error creating user:", error);
                    showNotification("Failed to create user account", "error");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }
            });

            // Update password form
            document.getElementById('updatePasswordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalHTML = submitBtn.innerHTML;

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="loading"></div> Updating...';
                    
                    const response = await fetch(`https://bkpmanual.bitnexdial.com/api/admin/update-password/${currentUpdatingUserId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword })
                    });

                    const result = await response.json();
                    showNotification(result.message, response.ok ? "success" : "error");
                    closePasswordModal();
                    if (response.ok) fetchUsers();
                } catch (error) {
                    console.error('Error updating password:', error);
                    showNotification('Failed to update password', "error");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }
            });

            // Update email form
            document.getElementById('updateEmailForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('updateEmailUserId').value;
                const newEmail = document.getElementById('newEmail').value.trim();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalHTML = submitBtn.innerHTML;

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="loading"></div> Updating...';
                    
                    const response = await fetch(`https://bkpmanual.bitnexdial.com/api/admin/update-email/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newEmail })
                    });
                    const result = await response.json();
                    showNotification(result.message, response.ok ? "success" : "error");
                    closeEmailModal();
                    if (response.ok) fetchUsers();
                } catch (error) {
                    console.error("Email update failed:", error);
                    showNotification("Failed to update email address", "error");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }
            });
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape key closes modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            // Ctrl+R for refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
        });
        // Add this debug function to your admin.html script section

// Debug function to test phone data
async function debugPhoneData(phoneNumber) {
    if (!phoneNumber) {
        phoneNumber = prompt("Enter phone number to debug:");
        if (!phoneNumber) return;
    }

    try {
        const response = await fetch("https://bkpmanual.bitnexdial.com/api/admin/debug-phone-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phoneNumber: phoneNumber })
        });

        const result = await response.json();
        
        if (response.ok) {
            // Create debug modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let debugHtml = `
                <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: var(--gray-100); padding: 1rem; border-radius: var(--border-radius); max-height: 400px; overflow-y: auto;">
                    <h4 style="font-family: 'Inter', sans-serif; margin-bottom: 1rem;">Debug Results for ${result.debug.phoneNumber}</h4>
                    <div style="margin-bottom: 1rem;">
                        <strong>Original:</strong> ${result.debug.phoneNumber}<br>
                        <strong>Normalized:</strong> ${result.debug.cleanPhone}
                    </div>
                    
                    <h5 style="color: var(--primary); margin: 1rem 0 0.5rem 0;">SMS Messages (${result.debug.actualData.sms?.count || 0})</h5>
                    ${result.debug.actualData.sms?.samples?.map(s => `
                        <div style="background: rgba(99, 102, 241, 0.1); padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px;">
                            Sender: ${s.sender} (${s.normalized_sender})<br>
                            Receiver: ${s.receiver} (${s.normalized_receiver})<br>
                            Preview: ${s.body_preview}
                        </div>
                    `).join('') || '<div>No SMS messages found</div>'}
                    
                    <h5 style="color: var(--primary); margin: 1rem 0 0.5rem 0;">Call Records (${result.debug.actualData.calls?.count || 0})</h5>
                    ${result.debug.actualData.calls?.samples?.map(c => `
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px;">
                            Caller: ${c.caller} (${c.normalized_caller})<br>
                            Callee: ${c.callee} (${c.normalized_callee})<br>
                            Time: ${c.start_time}
                        </div>
                    `).join('') || '<div>No call records found</div>'}
                    
                    <h5 style="color: var(--primary); margin: 1rem 0 0.5rem 0;">Contacts (${result.debug.actualData.contacts?.count || 0})</h5>
                    ${result.debug.actualData.contacts?.samples?.map(c => `
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px;">
                            Owner: ${c.owner}<br>
                            Contact: ${c.contact} (${c.normalized_contact})<br>
                            Name: ${c.name}
                        </div>
                    `).join('') || '<div>No contacts found</div>'}
                    
                    <h5 style="color: var(--primary); margin: 1rem 0 0.5rem 0;">Recordings (${result.debug.actualData.recordings?.count || 0})</h5>
                    <div>Recording Dir: ${result.debug.actualData.recordings?.recordingDir}</div>
                    <div>Dir Exists: ${result.debug.actualData.recordings?.dirExists}</div>
                    ${result.debug.actualData.recordings?.foundFiles?.map(f => `
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px;">
                            File: ${f.filename}<br>
                            Path: ${f.filepath}<br>
                            Match: ${f.matchReason}<br>
                            Size: ${f.size} bytes
                        </div>
                    `).join('') || '<div>No recordings found</div>'}
                </div>
            `;

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h3 class="modal-title">
                        <i class="fas fa-bug" style="color: var(--info);"></i>
                        Phone Data Debug Results
                    </h3>
                    ${debugHtml}
                    <div style="text-align: center; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                            Close Debug
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
        } else {
            showNotification(`Debug failed: ${result.error}`, "error");
        }
    } catch (error) {
        console.error("Error debugging phone data:", error);
        showNotification("Failed to debug phone data", "error");
    }
}

// Add this to your topbar-actions section in admin.html:
/*
<button class="btn btn-info" onclick="debugPhoneData()">
    <i class="fas fa-bug"></i>
    Debug Phone
</button>
*/
    </script>
</body>
</html>
